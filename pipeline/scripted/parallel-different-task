#!/usr/bin/groovy
parameters = [
	booleanParam(
		defaultValue: false,
		description: 'Reload Jenkinsfile',
		name: 'RELOAD'
	),
	string(
		defaultValue: '',
		description: 'Custom label for job build',
		name: 'LABEL'
	)
]

properties([
	parameters(parameters)
])

timestamps {
	node {
		echo "Reload: ${params.RELOAD}, Build label: ${params.LABEL}"

		def reloadOnly = params.RELOAD || currentBuild.number == 1
		if (reloadOnly) {
			currentBuild.displayName = "Reload Jenkinsfile"
			return
		}

		if (params.LABEL) {
			currentBuild.displayName = "${params.LABEL}"
		}

		stage("Parallel run") {
			parallel(
				"task1": {
					node("java") {
						echo "this build is run on docker-java"
						sh 'sleep 10'
						def ip = sh(script: 'hostname -i', returnStdout:true).trim()
	    				echo "IP: ${ip}"
					}
				},
				"task2": {
					node("python") {
						echo "this build is run on docker-python"
						sh 'sleep 10'
						def ip = sh(script: 'hostname -i', returnStdout:true).trim()
	    				echo "IP: ${ip}"
					}
				}
			)
		}
	}
}
